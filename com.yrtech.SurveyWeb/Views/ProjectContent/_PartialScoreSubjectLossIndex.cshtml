
<div style="float:right;">
    <button id="btnAdd" class="btn btn-primary" style="margin-right:0px" onclick="addLossResult()" data-loading-text="提交中...">新增</button>

    <button id="btnAdd" class="btn btn-primary" style="margin-right:0px" onclick="saveLossResult()" data-loading-text="提交中...">保存</button>
</div>
<table id="subject-lossResult-table" class="table table-bordered table-set"></table>
<script>
    $(function () {
        initSubjectLossResult();
        loadSubjectLossResult();

        $("#LossResultCheckList").find("input[type=checkbox]").iCheckParser();
    })

    function closeLossModel() {
        $("#lossModal").modal("hide");
    }
    function showLossModel() {
        $("#lossModal").modal("show");
    }

    function bindSubjectLossResultList(lossDic) {
        $("#LossResultCheckList").empty()
        lossDic.forEach(function (r) {
            var checkbox = $('<label class="col-md-6"><input type="checkbox"> <span class="checkbox-label"></span></label>')
            checkbox.find('span').text(r.LossResultName)
            checkbox.find('inout:checkbox').val(r.LossResultName)
            $("#LossResultCheckList").append(checkbox)
        })
        $("#LossResultCheckList").find("input[type=checkbox]").iCheckParser();
    }

    function initSubjectLossResult() {
        $('#subject-lossResult-table').bootstrapTable({
            pagination: false,
            striped: true, //是否显示行间隔色
            pageNumber: 1,
            pageSize: 10,
            pageList: [10],
            columns: [{
                title: "失分说明",
                field: "LossDesc",
                width: 120,
                valign: "middle",
                align: "center",
                sortable: false
            }, {
                title: "补充失分说明",
                field: "LossDesc2",
                width: 120,
                valign: "middle",
                align: "center",
                sortable: false
            }, {
                title: "编辑",
                field: "",
                width: 60,
                valign: "middle",
                align: "center",
                sortable: false,
                formatter: function (value, row, index) {
                    return '<a href="javascript:editLossResult();" style="min-width:100px">编辑</a>';
                }
            }, {
                title: "查看",
                field: "",
                width: 60,
                valign: "middle",
                align: "center",
                sortable: false,
                formatter: function (value, row, index) {
                    return '<a href="javascript:viewLossFile();" style="min-width:100px">查看</a>';
                }
            }, {
                title: "删除",
                field: "",
                width: 60,
                valign: "middle",
                align: "center",
                sortable: false,
                formatter: function (value, row, index) {
                    return '<a href="javascript:delLossResutl();" style="min-width:100px">删除</a>';
                }
            }],
            onClickRow: function (row, $element) {
                curLossRow = row;
            }
        });
    }

    function loadSubjectLossResult() {
        curLossRow = undefined
        $('#subject-lossResult-table').bootstrapTable("showLoading");
        $.commonGet("Answer/GetShopAnswerScoreInfo", {
            projectId: $("#project-sel").val(),
            shopId: $("#shop-sel").val(),
            subjectId: curRow.SubjectId,
            key: ''
        }, function (data) {
            console.log('data', data)
            if (data && data.length > 0) {
                let item = data[0]
                let LossResult = item.LossResult?JSON.parse(item.LossResult):[]
                $('#subject-lossResult-table').bootstrapTable("hideLoading");
                $('#subject-lossResult-table').bootstrapTable("load", LossResult);

                debugger
                bindSubjectLossResultList(item.SubjectLossResultList)
            }
        });
    }

    function saveCurLossResult() {        
        let lossArr = []
        $.each($("#LossResultCheckList").find("input[type=checkbox]:checked"), function (i, checkbox) {
            let lossValue = $(checkbox).parent().parent().find('.checkbox-label').text()
            lossArr.push( lossValue)
        });
        debugger
        if (curLossRow) {
            //编辑
            curLossRow.LossDesc = lossArr.join(',');
            curLossRow.LossDesc2 = $('#LossDesc2').val()
            let data = $('#subject-lossResult-table').bootstrapTable('getData', false)
            $('#subject-lossResult-table').bootstrapTable("load", data);
        } else {
            //新增
            let data = $('#subject-lossResult-table').bootstrapTable('getData', false)
            data.push({
                LossDesc: lossArr.join(','),
                LossDesc2:$('#LossDesc2').val()
            })
            $('#subject-lossResult-table').bootstrapTable("load", data);
        }
        closeLossModel();
    }

    function saveLossResult() {
        let data = $('#subject-lossResult-table').bootstrapTable('getData', false)
        curRow.LossResult = JSON.stringify(data);
        $.commonPost("Answer/SaveAnswerInfo", curRow, function () {
            alert("保存成功！");
            closeModel();
        }, function () { });
    }

    function addLossResult() {
        showLossModel();
        $('#LossDesc2').val('')
        $.each($("#LossResultCheckList").find("input[type=checkbox]"), function (i, checkbox) {
            $(checkbox).iCheck('uncheck');
        });
    }

    function editLossResult() {
        showLossModel();       
        curLossRow.LossDesc2 = curLossRow.LossDesc2||''
        curLossRow.LossDesc = curLossRow.LossDesc || ''
        $('#LossDesc2').val(curLossRow.LossDesc2)
        let lossDescArr = curLossRow.LossDesc.split(',')
        $.each($("#LossResultCheckList").find("input[type=checkbox]"),function (i,checkbox) {
            let lossValue = $(checkbox).parent().parent().find('.checkbox-label').text()
            console.log('checkbox value', lossValue)
            if (lossDescArr.indexOf(lossValue) >= 0) {
                $(checkbox).iCheck('check');
            }
        });
    }

    function viewLossFile() {
        let fileList = curLossRow.LossFileNameUrl?curLossRow.LossFileNameUrl.split(','):[]
        if (!fileList || fileList.length == 0) {
            alert("没有照片！")
            return;
        }
        var imgBox = $('#baguetteBox');
        imgBox.empty()
        var count = fileList.length;
        $.each(fileList, function (i, item) {
            var imgUrl = loginUser.ossInfo.osshost + item;
            var imgThumbUrl = imgUrl + '?x-oss-process=image/resize,m_fill,h_180,w_240';
            var imagA = $('<a></a>');
            let name = item.substr(item.lastIndexOf('/') + 1);
            var img = $('<img>').attr('src', imgThumbUrl).attr("alt", (i + 1) + "/" + count + "   " + name);
            $(imagA).append(img);
            $(imagA).attr('href', imgUrl);
            $(imagA).attr('data-caption', (i + 1) + "/" + count + "   " + name);

            imgBox.append(imagA);
        })
        baguetteBox.run('#baguetteBox', {
            animation: 'fadeIn'
        });

        setTimeout(function () {
            imgBox.find("a:first img").click();
        }, 300)
    }

    function delLossResutl() {

    }
</script>



