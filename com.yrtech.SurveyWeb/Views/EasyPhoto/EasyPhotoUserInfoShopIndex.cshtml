@{
    ViewBag.Title = "轻松拍-账号管理";
}


<div class="page-title">
    <div class="title_left">
        <h3>账号经销商管理 <small></small></h3>
    </div>
</div>

<div class="operation col-md-offset-2 form-horizontal">
    <div class="row">
        <div class="col-md-10">
            <label class="control-label col-md-offset-6 col-md-2">期号</label>
            <div class="col-md-4">
                <select id="project-sel" class="form-control"></select>
            </div>
        </div>
        <div class="col-md-1">
            <button id="btnSearch" class="btn btn-primary form-control">查&nbsp;&nbsp;询</button>
        </div>
        <div class="col-md-1">
            <button id="btnAdd" class="btn btn-primary form-control">新&nbsp;&nbsp;增</button>
        </div>
    </div>
</div>
<table id="userInfoShop-table" class="table table-striped table-bordered dt-responsive">
    <thead>
        <tr>
            <th width="100">账号</th>
            <th width="120">用户名</th>
            <th width="120">经销商代码</th>
            <th>经销商名称</th>
            <th width="180">登记时间</th>
            @*<th width="180">最新修改时间</th>*@
            <th width="100">操作</th>
        </tr>
    </thead>
    <tbody></tbody>
</table>
<div id="pagination" class="pull-right">
    <ul id="pageUl"></ul>
</div>
<div class="modal fade" id="Modal" tabindex="-1" role="dialog" aria-hidden="false" data-backdrop="static" data-keyboard="false">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title"></h4>
            </div>
            <div class="modal-body">
            </div>
            <div class="modal-footer">
                <button id="save_button" type="button" onclick="saveEasyPhotoUserInfo()" class="btn btn-primary" data-loading-text="提交中...">保存</button>
                <button id="close_button" type="button" onclick="javascript:closeModel();" class="btn btn-default">关闭</button>
            </div>
        </div>
    </div>
</div>
@section scripts{
    <script src="~/Scripts/api/common.js"></script>
    <script src="~/Scripts/api/easyphoto.js"></script>
    <script src="~/Scripts/form-serialize.js"></script>
    <script src="~/Scripts/page.js"></script>
    <script>
        $(function () {
            loadEasyPhotoProjectDropList();            

            $("#btnSearch").click(function () {
                loadEasyPhotoUserInfoShop($("#project-sel").val(), "", "", "");
            });

            $("#btnAdd").click(function () {
                $("#Modal").modal("show");
                $("#Modal .modal-body").load("/EasyPhoto/EasyPhotoUserInfoShopEdit", {}, function () {
                    $("#ProjectId").val($("#project-sel").val());
                    $("#ProjectName").val($("#project-sel").text());
                })
                return false;
            });
        })

        //保存轻松拍的账号经销商
        function saveEasyPhotoUserInfo() {
            //API接口使用了UploadData  接受集合的json字符串
            var selShop = findShop();            
            var selUser = findUser();
            saveEasyPhotoCommonList("SaveUserInfoShop", $("#userInfoShop-form"), {
                //新增
                TenantId: loginUser.TenantId,
                InUserId: loginUser.Id,
                ModifyUserId: loginUser.Id,
                AccountId:selUser.AccountId,
                AccountName: selUser.AccountName,
                ShopCode: selShop.ShopCode,
                ShopName: selShop.ShopName,
            }, function () {
                $("#btnSearch").click();
            });
        }

        function findShop() {
            var selShop = {};
            if (shopList) {
                var findArr = shopList.filter(function (shop) {
                    return (shop.ShopId == $("#ShopId").val());
                })
                if (findArr.length > 0) {
                    selShop = findArr[0]
                }
            }
            return selShop;
        }
        function findUser() {
            var selUser = {};
            if (userList) {
                var findArr = userList.filter(function (user) {
                    return (user.Id == $("#UserId").val());
                })
                if (findArr.length > 0) {
                    selUser = findArr[0]
                }
            }
            return selUser;
        }

        // 查询账号
        function loadEasyPhotoUserInfoShop(projectId, shopId, key, userId) {
            loadEasyPhotoMasterCommonGet("GetUserInfoShop", {
                projectId: projectId,
                shopId: shopId || "",
                key: key || "",
                userId: loginUser.Id
            }, function (data) {
                var pageClick = function (curPage) {
                    bindTable(data, $("#userInfoShop-table"), curPage);
                }
                pageClick(curPageNum);
                createPage(data.length, curPageNum, pageSize, pageClick);
            })

        }


        function bindTable(data, table, curPage) {
            $("tbody", table).empty();

            var pageLst = data.filter(function (item, i, self) {
                var start = curPage > 0 ? (curPage - 1) * pageSize : 0;
                return (i >= start && i < (start + pageSize));
            })
            $.each(pageLst, function (i, item) {
                //page
                var tr = $("<tr>");

                tr.append($("<td></td>").html(item.AccountId));
                tr.append($("<td></td>").html(item.AccountName));
                tr.append($("<td></td>").html(item.ShopCode));
                tr.append($("<td></td>").html(item.ShopName));
                tr.append($("<td></td>").html(item.InDateTime.replace('T', ' ')));
                //if (item.ModifyDateTime) {
                //    tr.append($("<td></td>").html(item.ModifyDateTime.replace('T', ' ')));
                //} else {
                //    tr.append($("<td></td>").html(''));
                //}
                var edit = $("<a href='#'>删除</a>");
                edit.click(function () {
                    confirm("确定删除记录吗？", function () {
                        $.post(easyPhotoUrl + "easyPhoto/api/Master/DeleteUserInfoShop", {
                            AnswerListJson: JSON.stringify([item])
                        }, function (data) {
                            if (data && data.Status) {
                                $("#btnSearch").click();
                            } else {
                                alert(data.Body);
                            }
                        })
                    });
                    return false;
                })
                tr.append($("<td></td>").append(edit));

                $("tbody", table).append(tr);
            })
        }

    </script>
}



